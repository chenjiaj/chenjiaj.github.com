
---
title: 小程序总结
date:  2019. 01.18 10:15
categories: '微信'
tags: [微信, 小程序]
---

### 一、获取用户信息

获取用户信息，需要用户点击按钮弹出授权弹出，用户同意后才能获取

    <!-- wxml 需要使用 button 来授权登录 -->
    <button wx:if="{{canIUse}}" open-type="getUserInfo" bindgetuserinfo="bindGetUserInfo">授权登录</button>

bindGetUserInfo 方法的参数中也可以获取到用户信息，第一次可以从这个方法中取

获取到的用户信息中不包括敏感信息openId\unionId，如果要获取用户敏感信息，需要wx.login登录

    // js
    wx.getSetting({
      success (res){
        if (res.authSetting['scope.userInfo']) {
          // 已经授权，可以直接调用 getUserInfo 获取头像昵称
          wx.getUserInfo({
            success: function(res) {
              console.log(res.userInfo)
            }
          })
        }
      }
    })
    
![用户信息](/images/小程序总结-img/1.png)

### 二、用户登录

1.  调用 [wx.login()](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html) 获取 **临时登录凭证code** ，并回传到开发者服务器。

2.  调用 [auth.code2Session](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/login/auth.code2Session.html) 接口，换取 **用户唯一标识 OpenID** 和 **会话密钥 session_key**。

3.通过code获取到的**session_key**与小程序**appID**创建一个对象

4.将小程序wx.getUserInfo获取到的参数encryptedData、iv传到后台解密。

      const pc = new WXBizDataCrypt(weChat.appId, data.sessionKey);
      const userData = pc.decryptData(params.encryptedData, params.iv);

![获取到的数据](/images/小程序总结-img/2.png)



